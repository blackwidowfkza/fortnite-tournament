<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Epic Verification | FKZA Duo Cash Cup</title>
  <link rel="icon" href="https://i.ibb.co/FbL2kmSn/Untitled-design-1.png" type="image/png">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --bg-primary: #0f0f13;
      --bg-secondary: #1a1a24;
      --bg-card: #252535;
      --text-primary: #f8f8ff;
      --text-secondary: #b8b8d0;
      --accent-purple: #6d28d9;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --border-color: #3a3a4a;
      --border-radius: 12px;
      --transition: all 0.25s ease;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      text-align: center;
      padding: 1rem 0.5rem;
      background: rgba(15,15,19,0.9);
      border-bottom: 1px solid var(--border-color);
    }
    header img {
      height: 60px;
      border-radius: 50%;
      border: 2px solid var(--accent-purple);
      box-shadow: 0 0 12px rgba(109,40,217,0.5);
      transition: var(--transition);
    }
    header img:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(109,40,217,0.7);
    }
    header h1 {
      font-family: 'Oxanium', sans-serif;
      font-size: 1.8rem;
      margin-top: 0.5rem;
      background: linear-gradient(90deg, #8b5cf6, #3b82f6);
      -webkit-background-clip: text;
      color: transparent;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 1000px;
      margin: 1rem auto;
      padding: 0 1rem;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @media (min-width: 600px) {
      .teams-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (min-width: 900px) {
      .teams-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .team-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: var(--transition);
      overflow: hidden;
    }
    .team-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .team-header {
      background: var(--bg-secondary);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .team-header h2 {
      font-family: 'Oxanium', sans-serif;
      font-size: 1.2rem;
      color: var(--accent-blue);
    }
    .team-body {
      padding: 1rem;
    }
    .field-group {
      margin-bottom: 0.75rem;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      color: var(--text-secondary);
    }
    .input-wrapper {
      position: relative;
      width: 100%;
    }
    input.epic-input {
      width: 100%;
      padding: 0.5rem 2.5rem 0.5rem 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: var(--transition);
    }
    input.epic-input:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 0 2px rgba(109,40,217,0.3);
    }
    input.epic-input[readonly] {
      background: #2e2e3a;
      color: var(--text-secondary);
      cursor: default;
      opacity: 0.7;
    }
    .save-btn {
      position: absolute;
      right: 0.25rem;
      top: 50%;
      transform: translateY(-50%);
      background: var(--accent-green);
      border: none;
      color: var(--text-primary);
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }
    .save-btn:disabled {
      display: none;
    }
    .save-btn:not(:disabled):hover {
      background: var(--accent-blue);
    }

    #message {
      text-align: center;
      margin-top: 0.75rem;
      font-size: 0.95rem;
      min-height: 1.2rem;
      color: var(--accent-green);
    }
  </style>
</head>
<body>
  <header>
    <img src="https://i.ibb.co/FbL2kmSn/Untitled-design-1.png" alt="FKZA Logo">
    <h1>Epic Verification</h1>
  </header>

  <main>
    <div class="teams-grid" id="teamsContainer">
      <div style="grid-column: 1 / -1; text-align:center; color: var(--text-secondary);">
        Loading…
      </div>
    </div>
    <div id="message"></div>
  </main>

  <script>
    // ─────────────────────────────────────────────────────────────────────
    //  IMPORTANT: Replace the entire string below with your actual Apps Script
    //  Web App URL (the one that ends in "/exec"). Example:
    //    const SCRIPT_URL = 
    //      "https://script.google.com/macros/s/AKfycbx12345abcdef67890abcdefg/exec";
    //  Do NOT use any relative path like "exec?…". It must be the full /exec URL.
    // ─────────────────────────────────────────────────────────────────────
    const SCRIPT_URL = 
      "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID_HERE/exec";

    /**
     * Display a brief success or error message at the bottom.
     */
    function showMessage(text, isError = false) {
      const msgEl = document.getElementById("message");
      msgEl.textContent = text;
      msgEl.style.color = isError ? "var(--accent-red)" : "var(--accent-green)";
      setTimeout(() => {
        if (msgEl.textContent === text) {
          msgEl.textContent = "";
        }
      }, 3000);
    }

    /**
     * JSONP callback function. The Apps Script doGet responds with:
     *   handleList({ registrations:[…], epics:[…] });
     */
    function handleList(response) {
      if (response.error) {
        showMessage("Error loading teams: " + response.error, true);
        return;
      }
      renderTeams(response.registrations, response.epics);
    }

    /**
     * Inject a <script> tag that points to our Apps Script URL with:
     *   ?action=list&callback=handleList
     * This bypasses CORS by using JSONP.
     */
    function fetchAllTeamsViaJSONP() {
      const existing = document.getElementById("jsonpScript");
      if (existing) existing.remove();

      const script = document.createElement("script");
      script.id = "jsonpScript";
      script.src = `${SCRIPT_URL}?action=list&callback=handleList`;
      document.body.appendChild(script);
    }

    /**
     * Given arrays of registrations and epics, render each team card.
     *
     * registrations: [ { id, player, duo }, … ]
     * epics:         [ { discord, epic }, … ]
     */
    function renderTeams(registrations, epics) {
      const container = document.getElementById("teamsContainer");
      container.innerHTML = ""; // clear "Loading…"

      if (!Array.isArray(registrations) || registrations.length === 0) {
        const msg = document.createElement("div");
        msg.style.gridColumn = "1 / -1";
        msg.style.textAlign = "center";
        msg.style.color = "var(--text-secondary)";
        msg.textContent = "No registrations found.";
        container.appendChild(msg);
        return;
      }

      registrations.forEach(reg => {
        // Find saved epic for this player or duo (if any)
        const playerEpicObj = epics.find(e => e.discord === reg.player);
        const duoEpicObj    = epics.find(e => e.discord === reg.duo);
        const epic1 = playerEpicObj ? playerEpicObj.epic : "";
        const epic2 = duoEpicObj    ? duoEpicObj.epic    : "";

        const card = createTeamCard({
          teamId: reg.id,
          player: reg.player,
          duo:    reg.duo,
          epic1:  epic1,
          epic2:  epic2
        });
        container.appendChild(card);
      });
    }

    /**
     * Create a “card” for a single team. Shows:
     *   • Player: <input for epic1>
     *   • Duo:    <input for epic2>
     * If the epic is already filled, that field is read-only/greyed and the ✓ button is hidden.
     */
    function createTeamCard(team) {
      const { teamId, player, duo, epic1, epic2 } = team;
      const card = document.createElement("div");
      card.classList.add("team-card");

      // — Header —
      const header = document.createElement("div");
      header.classList.add("team-header");
      const h2 = document.createElement("h2");
      h2.textContent = `Team ${teamId}`;
      header.appendChild(h2);
      card.appendChild(header);

      // — Body —
      const body = document.createElement("div");
      body.classList.add("team-body");

      // —— Player field group —— 
      const playerGroup = document.createElement("div");
      playerGroup.classList.add("field-group");

      const label1 = document.createElement("label");
      label1.textContent = `Player: ${player}`;
      playerGroup.appendChild(label1);

      const wrapper1 = document.createElement("div");
      wrapper1.classList.add("input-wrapper");

      const input1 = document.createElement("input");
      input1.classList.add("epic-input");
      input1.type = "text";
      input1.placeholder = "Enter Epic Name";
      input1.value = epic1 || "";
      if (epic1) {
        input1.readOnly = true;
        input1.style.opacity = 0.7;
      }
      wrapper1.appendChild(input1);

      const btn1 = document.createElement("button");
      btn1.classList.add("save-btn");
      btn1.textContent = "✔";
      btn1.disabled = !!epic1; // hide if already saved
      wrapper1.appendChild(btn1);

      playerGroup.appendChild(wrapper1);
      body.appendChild(playerGroup);

      // —— Duo field group —— 
      const duoGroup = document.createElement("div");
      duoGroup.classList.add("field-group");

      const label2 = document.createElement("label");
      label2.textContent = `Duo: ${duo}`;
      duoGroup.appendChild(label2);

      const wrapper2 = document.createElement("div");
      wrapper2.classList.add("input-wrapper");

      const input2 = document.createElement("input");
      input2.classList.add("epic-input");
      input2.type = "text";
      input2.placeholder = "Enter Epic Name";
      input2.value = epic2 || "";
      if (epic2) {
        input2.readOnly = true;
        input2.style.opacity = 0.7;
      }
      wrapper2.appendChild(input2);

      const btn2 = document.createElement("button");
      btn2.classList.add("save-btn");
      btn2.textContent = "✔";
      btn2.disabled = !!epic2; // hide if already saved
      wrapper2.appendChild(btn2);

      duoGroup.appendChild(wrapper2);
      body.appendChild(duoGroup);

      // — “Save” logic for Player —
      btn1.addEventListener("click", async () => {
        const val = input1.value.trim();
        if (!val) return;
        input1.readOnly = true;
        input1.style.opacity = 0.7;
        btn1.disabled = true;
        showMessage(`Saving for ${player}…`);
        try {
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ discord: player, epic: val })
          });
          console.log(`POST for ${player}:`, res);
          const json = await res.json();
          console.log("POST response:", json);
          if (!json.success) throw new Error(json.message || "Error");
          btn1.style.display = "none";
          showMessage(`Saved for ${player}`);
        } catch (err) {
          console.error("Error saving player epic:", err);
          input1.readOnly = false;
          input1.style.opacity = 1;
          btn1.disabled = false;
          showMessage(err.message, true);
        }
      });

      // — “Save” logic for Duo —
      btn2.addEventListener("click", async () => {
        const val = input2.value.trim();
        if (!val) return;
        input2.readOnly = true;
        input2.style.opacity = 0.7;
        btn2.disabled = true;
        showMessage(`Saving for ${duo}…`);
        try {
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ discord: duo, epic: val })
          });
          console.log(`POST for ${duo}:`, res);
          const json = await res.json();
          console.log("POST response:", json);
          if (!json.success) throw new Error(json.message || "Error");
          btn2.style.display = "none";
          showMessage(`Saved for ${duo}`);
        } catch (err) {
          console.error("Error saving duo epic:", err);
          input2.readOnly = false;
          input2.style.opacity = 1;
          btn2.disabled = false;
          showMessage(err.message, true);
        }
      });

      card.appendChild(body);
      return card;
    }

    // Kick off JSONP fetch on page load
    document.addEventListener("DOMContentLoaded", fetchAllTeamsViaJSONP);
  </script>
</body>
</html>
